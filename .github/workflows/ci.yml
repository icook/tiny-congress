name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.sha }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io/${{ github.repository }}

jobs:
  # ============================================================
  # JOB 0: Lint Rust formatting
  # ============================================================
  lint:
    name: Lint Rust formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Lint backend
        run: just lint-backend

  # ============================================================
  # JOB 0b: Lint web
  # ============================================================
  lint-web:
    name: Lint web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: web/.nvmrc
          cache: yarn
          cache-dependency-path: web/yarn.lock

      - name: Enable corepack
        run: corepack enable

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Install dependencies
        run: just install-frontend

      - name: Run Linters
        run: just lint-frontend

  # ============================================================
  # JOB 0b2: Build Storybook
  # ============================================================
  storybook-build:
    name: Build Storybook
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: web/.nvmrc
          cache: yarn
          cache-dependency-path: web/yarn.lock

      - name: Enable corepack
        run: corepack enable

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Install dependencies
        run: just install-frontend

      - name: Build Storybook
        run: just storybook-build

      - name: Upload Storybook artifact
        uses: actions/upload-artifact@v6
        with:
          name: storybook-static
          path: web/storybook-static/
          retention-days: 30

  # ============================================================
  # JOB 0b3: Build API Documentation
  # ============================================================
  build-docs:
    name: Build documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build Rust docs
        run: cargo doc --workspace --no-deps

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: web/.nvmrc
          cache: yarn
          cache-dependency-path: web/yarn.lock

      - name: Enable corepack
        run: corepack enable

      - name: Install dependencies
        run: cd web && yarn install --immutable

      - name: Build TypeScript docs
        working-directory: web
        run: yarn typedoc

      - name: Upload docs artifact
        uses: actions/upload-artifact@v6
        with:
          name: docs
          path: |
            target/doc
            web/docs
          retention-days: 7

  # ============================================================
  # JOB 0c: Verify GraphQL codegen is up-to-date
  # ============================================================
  codegen-check:
    name: Check GraphQL codegen
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: web/.nvmrc
          cache: yarn
          cache-dependency-path: web/yarn.lock

      - name: Enable corepack
        run: corepack enable

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Install frontend dependencies
        run: just install-frontend

      - name: Run codegen
        run: just codegen

      - name: Check for uncommitted changes
        run: |
          if ! git diff --quiet web/schema.graphql web/src/api/generated/; then
            echo "::error::GraphQL codegen is out of date. Run 'just codegen' and commit the changes."
            git diff web/schema.graphql web/src/api/generated/
            exit 1
          fi
          echo "‚úì GraphQL codegen is up to date"

  # ============================================================
  # JOB 0d: Security & Dependency Audit
  # ============================================================
  security-audit:
    name: Security & Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for gitleaks

      # Rust: advisories + licenses via cargo-deny
      - name: Install cargo-deny
        uses: taiki-e/install-action@cargo-deny

      - name: Run cargo deny
        working-directory: service
        run: cargo deny check

      # Rust: unused dependencies via cargo-machete
      - name: Install cargo-machete
        uses: taiki-e/install-action@cargo-machete

      - name: Check for unused dependencies
        working-directory: service
        run: |
          if ! cargo machete; then
            echo "::error::Unused dependencies detected. Remove them or add to Cargo.toml [package.metadata.cargo-machete] ignored list."
            exit 1
          fi

      # Frontend: vulnerabilities via yarn audit
      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: web/.nvmrc
          cache: yarn
          cache-dependency-path: web/yarn.lock

      - name: Enable corepack
        run: corepack enable

      - name: Install frontend dependencies
        run: cd web && yarn install --immutable

      - name: Run yarn audit
        working-directory: web
        run: yarn npm audit --severity high

      # Secrets detection via gitleaks
      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # JOB 0e: Verify SQLx query snapshots are up-to-date
  # ============================================================
  sqlx-check:
    name: Check SQLx snapshots
    runs-on: ubuntu-latest
    needs: [build-images]
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/tiny-congress
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start postgres
        run: |
          docker run -d --name postgres \
            -p 5432:5432 \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            ${{ env.REGISTRY }}/postgres:${{ github.sha }}
          # Wait for postgres to be ready
          for i in {1..30}; do
            if docker exec postgres pg_isready -U postgres; then
              echo "Postgres is ready"
              break
            fi
            echo "Waiting for postgres... ($i/30)"
            sleep 1
          done

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --locked --no-default-features --features postgres

      - name: Run migrations
        working-directory: service
        run: cargo sqlx migrate run

      - name: Check SQLx snapshots
        working-directory: service
        run: |
          output=$(cargo sqlx prepare --check 2>&1) || {
            echo "$output"
            echo "::error::SQLx query snapshots are out of date. Run 'just sqlx-prepare' and commit the changes in service/.sqlx/"
            exit 1
          }
          echo "$output"
          if echo "$output" | grep -q "potentially unused queries"; then
            echo "::error::Unused SQLx query snapshots found in .sqlx/. Run 'just sqlx-prepare' to remove stale entries."
            exit 1
          fi
          echo "‚úì SQLx snapshots are up to date"

  # ============================================================
  # JOB 1: Build all container images in parallel
  # ============================================================
  build-images:
    name: Build ${{ matrix.image }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: tc-api-release
            context: .
            dockerfile: service/Dockerfile
          - image: tc-ui-release
            context: .
            dockerfile: web/Dockerfile
          - image: postgres
            context: .
            dockerfile: dockerfiles/Dockerfile.postgres
    outputs:
      tc-api-release-tag: ${{ steps.meta.outputs.tc-api-release-tag }}
      tc-ui-release-tag: ${{ steps.meta.outputs.tc-ui-release-tag }}
      postgres-tag: ${{ steps.meta.outputs.postgres-tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: tags
        run: |
          ref="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          branch="${ref//[^a-zA-Z0-9_.-]/-}"
          branch="${branch,,}"
          echo "branch_slug=${branch}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${{ env.REGISTRY }}/${{ matrix.image }}:${{ github.sha }}" >> "$GITHUB_OUTPUT"
          echo "branch_tag=${{ env.REGISTRY }}/${{ matrix.image }}:branch-${branch}" >> "$GITHUB_OUTPUT"

      - name: Extract versions from mise.toml
        id: versions
        run: |
          RUST_VERSION=$(grep '^rust' mise.toml | sed 's/.*= *"\([^"]*\)".*/\1/')
          NODE_VERSION=$(grep '^node' mise.toml | sed 's/.*= *"\([^"]*\)".*/\1/')
          echo "rust=${RUST_VERSION}" >> "$GITHUB_OUTPUT"
          echo "node=${NODE_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build and push ${{ matrix.image }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            RUST_VERSION=${{ steps.versions.outputs.rust }}
            NODE_VERSION=${{ steps.versions.outputs.node }}
            GIT_SHA=${{ github.sha }}
            BUILD_TIME=${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}
          tags: |
            ${{ steps.tags.outputs.sha_tag }}
            ${{ steps.tags.outputs.branch_tag }}
          cache-from: |
            type=gha,scope=${{ matrix.image }}
            type=registry,ref=${{ env.REGISTRY }}/${{ matrix.image }}:cache
          cache-to: |
            type=gha,scope=${{ matrix.image }},mode=max
            type=registry,ref=${{ env.REGISTRY }}/${{ matrix.image }}:cache,mode=max

      - name: Export image metadata
        id: meta
        run: |
          echo "${{ matrix.image }}-tag=${{ steps.tags.outputs.sha_tag }}" >> "$GITHUB_OUTPUT"

  # ============================================================
  # JOB 1b: Scan container images for vulnerabilities
  # ============================================================
  scan-images:
    name: Scan ${{ matrix.image }}
    runs-on: ubuntu-latest
    needs: [build-images]
    strategy:
      fail-fast: false
      matrix:
        image:
          - tc-api-release
          - tc-ui-release
          - postgres
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: .trivyignore
          sparse-checkout-cone-mode: false

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.REGISTRY }}/${{ matrix.image }}:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
          trivyignores: '.trivyignore'

  # ============================================================
  # JOB 2: Run Skaffold test/deploy and host-based integration/E2E tests
  # ============================================================
  integration-tests:
    name: Integration tests
    runs-on: ubuntu-latest
    needs:
      - build-images
      - scan-images
      - lint
      - lint-web
      - storybook-build
      - codegen-check
      - sqlx-check
      - security-audit
    permissions:
      contents: read
      packages: read
      checks: write
    env:
      SKAFFOLD_DEFAULT_REPO: ghcr.io/${{ github.repository }}
      SKAFFOLD_PROFILE: ci
      PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.cache/ms-playwright
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install KinD tooling
        uses: helm/kind-action@v1.13.0
        with:
          install_only: true
          cluster_name: skaffold-ci

      - name: Start KinD cluster in background
        run: |
          set -euo pipefail
          KIND_LOG="${RUNNER_TEMP}/kind.log"

          echo "KIND_LOG=${KIND_LOG}" >> "$GITHUB_ENV"

          echo "Starting KinD cluster skaffold-ci (logs: ${KIND_LOG})"
          kind create cluster --name skaffold-ci --wait 0s >"${KIND_LOG}" 2>&1 &

      - name: Cache Skaffold
        id: cache-skaffold
        uses: actions/cache@v5
        with:
          path: /usr/local/bin/skaffold
          key: skaffold-v${{ hashFiles('.skaffold-version') }}

      - name: Install Skaffold
        if: steps.cache-skaffold.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          SKAFFOLD_VERSION=v$(cat .skaffold-version)
          curl -fsSL -o skaffold https://storage.googleapis.com/skaffold/releases/${SKAFFOLD_VERSION}/skaffold-linux-amd64
          sudo install skaffold /usr/local/bin/skaffold

      - name: Verify Skaffold installation
        run: |
          echo "Required: v$(cat .skaffold-version)"
          echo "Installed: $(skaffold version)"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Write Skaffold artifacts file
        id: artifacts
        run: |
          set -euo pipefail
          artifacts_file="${RUNNER_TEMP}/skaffold-artifacts.json"
          cat > "$artifacts_file" <<'EOF'
          {
            "builds": [
              {"imageName": "tc-api-release", "tag": "${{ env.REGISTRY }}/tc-api-release:${{ github.sha }}"},
              {"imageName": "tc-ui-release", "tag": "${{ env.REGISTRY }}/tc-ui-release:${{ github.sha }}"},
              {"imageName": "postgres", "tag": "${{ env.REGISTRY }}/postgres:${{ github.sha }}"}
            ]
          }
          EOF
          echo "Artifacts file contents:"
          cat "$artifacts_file"
          echo "file=${artifacts_file}" >> "$GITHUB_OUTPUT"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: web/.nvmrc
          cache: yarn
          cache-dependency-path: web/yarn.lock

      - name: Enable corepack
        run: corepack enable

      - name: Install web dependencies
        working-directory: web
        run: yarn install --immutable

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v5
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-${{ runner.os }}-${{ hashFiles('web/yarn.lock') }}

      - name: Install Playwright browsers
        working-directory: web
        run: yarn playwright install --with-deps chromium

      - name: Prepare test output directories
        run: |
          mkdir -p web/reports web/test-results web/coverage/playwright service/coverage
          rm -f service/coverage/backend-unit.lcov

      - name: Install wasm-pack
        run: cargo install wasm-pack --locked

      - name: Build WASM
        run: |
          cd crates/tc-crypto
          wasm-pack build --target web --release --out-dir ../../web/src/wasm/tc-crypto

      - name: Run Skaffold tests
        env:
          TEST_POSTGRES_IMAGE: ${{ env.REGISTRY }}/postgres:${{ github.sha }}
        run: |
          set -euo pipefail
          skaffold test -p ${SKAFFOLD_PROFILE} --build-artifacts "${{ steps.artifacts.outputs.file }}"

      - name: Generate Rust coverage
        env:
          TEST_POSTGRES_IMAGE: ${{ env.REGISTRY }}/postgres:${{ github.sha }}
        working-directory: service
        run: |
          set -euo pipefail
          cargo llvm-cov --lcov --output-path coverage/backend-unit.lcov --fail-under-lines 60

      - name: Upload Vitest coverage
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: vitest-coverage
          path: web/coverage/vitest/
          retention-days: 7

      - name: Wait for KinD readiness
        run: |
          set -euo pipefail
          : "${KIND_LOG:?KIND_LOG not set}"
          echo "Waiting for cluster API to become available..."
          if ! timeout 180 bash -c 'until kubectl cluster-info --context kind-skaffold-ci >/dev/null 2>&1; do sleep 5; done'; then
            echo "KinD did not finish starting in time; dumping logs."
            cat "${KIND_LOG}" || true
            exit 1
          fi
          kubectl version --client=true
          kubectl cluster-info
          kubectl get nodes -o wide

      - name: Configure registry access for KinD
        run: |
          set -euo pipefail
          kubectl create secret docker-registry ghcr-cred \
            --namespace default \
            --docker-server=ghcr.io \
            --docker-username="${{ github.actor }}" \
            --docker-password="${{ secrets.GITHUB_TOKEN }}" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl patch serviceaccount default \
            -n default \
            --type merge \
            -p '{"imagePullSecrets":[{"name":"ghcr-cred"}]}'

      - name: Deploy with Skaffold
        run: |
          set -euo pipefail
          skaffold deploy -p ${SKAFFOLD_PROFILE} --status-check=true \
            --build-artifacts "${{ steps.artifacts.outputs.file }}"

      - name: Build instrumented frontend for E2E tests
        working-directory: web
        run: PLAYWRIGHT_COVERAGE=1 yarn build

      - name: Analyze bundle size
        if: always()
        working-directory: web
        run: |
          set -euo pipefail
          {
            echo "### Bundle Size"
            echo ""
            echo "| Asset | Size | Gzip |"
            echo "|-------|------|------|"
            find dist -type f \( -name "*.js" -o -name "*.css" \) -exec sh -c '
              file="$1"
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
              gzip_size=$(gzip -c "$file" | wc -c)
              printf "| %s | %s | %s |\n" \
                "$(basename "$file")" \
                "$(numfmt --to=iec-i --suffix=B $size 2>/dev/null || echo "${size}B")" \
                "$(numfmt --to=iec-i --suffix=B $gzip_size 2>/dev/null || echo "${gzip_size}B")"
            ' _ {} \; | sort -k3 -h -r
            echo ""
            total_size=$(find dist -type f \( -name "*.js" -o -name "*.css" \) -exec stat -f%z {} + 2>/dev/null | awk '{sum+=$1} END {print sum}' || \
                         find dist -type f \( -name "*.js" -o -name "*.css" \) -exec stat -c%s {} + | awk '{sum+=$1} END {print sum}')
            echo "**Total:** $(numfmt --to=iec-i --suffix=B $total_size 2>/dev/null || echo "${total_size}B")"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Run Playwright E2E tests
        working-directory: web
        env:
          CI: true
          PLAYWRIGHT_COVERAGE: "1"
          PLAYWRIGHT_BASE_URL: http://localhost:5173
          PLAYWRIGHT_API_URL: http://localhost:8080/graphql
        run: |
          set -euo pipefail

          # Port-forward API from cluster
          kubectl port-forward service/tc 8080:8080 &
          PF_API_PID=$!
          timeout 60 bash -c 'until curl -sf http://localhost:8080/health >/dev/null; do sleep 1; done'

          # Start local preview server with instrumented build
          yarn preview --host 0.0.0.0 --port 5173 --strictPort &
          PREVIEW_PID=$!
          timeout 60 bash -c 'until curl -sf http://localhost:5173 >/dev/null; do sleep 1; done'

          # Run tests - coverage report generated in Playwright global teardown
          yarn playwright:clean
          yarn playwright:test || TEST_EXIT=$?

          # Cleanup
          kill $PREVIEW_PID $PF_API_PID 2>/dev/null || true
          exit ${TEST_EXIT:-0}

      - name: Publish Playwright test report
        if: always() && hashFiles('web/reports/playwright.xml') != ''
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: web/reports/playwright.xml
          report_individual_runs: true
          check_name: Playwright E2E
          comment_mode: off

      - name: Upload Playwright test artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-test-results
          if-no-files-found: warn
          path: |
            web/test-results
            web/reports/playwright.xml
            web/reports/playwright-results.json
            web/playwright-report

      - name: Analyze Playwright flakiness
        if: always()
        working-directory: web
        run: node scripts/analyze-playwright-flakiness.mjs >> $GITHUB_STEP_SUMMARY

      - name: Upload Rust coverage artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: rust-coverage
          if-no-files-found: warn
          path: |
            service/coverage/backend-unit.lcov

      - name: Summarize coverage to job summary
        if: always()
        run: |
          node scripts/summarize-coverage.mjs \
            --vitest web/coverage/vitest/coverage-summary.json \
            --playwright web/coverage/playwright/coverage-summary.json \
            --rust "service/coverage/backend-unit.lcov:unit" \
            >> $GITHUB_STEP_SUMMARY

      - name: Install lcov for HTML generation
        if: always()
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Build unified coverage report
        if: always()
        working-directory: web
        run: node scripts/build-coverage-report.mjs

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage-report/
          retention-days: 7

      - name: Dump diagnostics on failure
        if: failure()
        run: |
          echo '--- Pods ---'
          kubectl get pods -A -o wide || true
          echo '--- Services ---'
          kubectl get svc -A || true
          echo '--- Events ---'
          kubectl get events -A --sort-by=.lastTimestamp || true
          echo '--- All Resources ---'
          kubectl get all -n default || true

  # ============================================================
  # JOB 2b: Update gitops repo with image digests (master only)
  # ============================================================
  deploy-gitops:
    name: Update gitops image digests
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: [integration-tests]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout gitops repo
        uses: actions/checkout@v6
        with:
          repository: icook/homelab-gitops
          ssh-key: ${{ secrets.GITOPS_DEPLOY_KEY }}
          ref: main

      - name: Get image digests from GHCR
        id: digests
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.sha }}"
          for IMAGE in tc-api-release tc-ui-release postgres; do
            DIGEST=$(gh api \
              "/users/icook/packages/container/tiny-congress%2F${IMAGE}/versions" \
              --jq ".[] | select(.metadata.container.tags[] == \"${SHA}\") | .name")
            echo "${IMAGE}=${DIGEST}" >> "$GITHUB_OUTPUT"
            echo "  ${IMAGE}: ${DIGEST}"
          done

      - name: Update HelmRelease digests
        run: |
          FILE="clusters/sauce/workloads/tiny-congress/helmrelease-demo.yaml"
          # Use yq to update only the digest fields
          yq -i '
            .spec.values.image.digest = "${{ steps.digests.outputs.tc-api-release }}" |
            .spec.values.frontend.image.digest = "${{ steps.digests.outputs.tc-ui-release }}" |
            .spec.values.postgres.image.digest = "${{ steps.digests.outputs.postgres }}"
          ' "$FILE"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add clusters/sauce/workloads/tiny-congress/helmrelease-demo.yaml
          # Only commit if there are actual changes
          if git diff --cached --quiet; then
            echo "No digest changes detected"
            exit 0
          fi
          git commit -m "chore: update tiny-congress image digests

          tc-api-release: ${{ steps.digests.outputs.tc-api-release }}
          tc-ui-release: ${{ steps.digests.outputs.tc-ui-release }}
          postgres: ${{ steps.digests.outputs.postgres }}"
          git push

  # ============================================================
  # JOB 3: Deploy to Cloudflare Pages
  # ============================================================
  deploy-cloudflare:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [integration-tests, storybook-build, build-docs]
    if: always() && needs.integration-tests.result != 'cancelled'
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - name: Checkout for assets
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            web/src/logo.png
            web/src/favicon.ico
          sparse-checkout-cone-mode: false

      - name: Create site directory
        run: |
          mkdir -p site
          cp web/src/logo.png site/logo.png
          cp web/src/favicon.ico site/favicon.ico

      - name: Download coverage report
        uses: actions/download-artifact@v7
        with:
          name: coverage-report
          path: site/coverage
        continue-on-error: true

      - name: Download Storybook
        uses: actions/download-artifact@v7
        with:
          name: storybook-static
          path: site/storybook
        continue-on-error: true

      - name: Download Playwright report
        uses: actions/download-artifact@v7
        with:
          name: playwright-test-results
          path: artifacts/playwright
        continue-on-error: true

      - name: Download docs
        uses: actions/download-artifact@v7
        with:
          name: docs
          path: artifacts/docs
        continue-on-error: true

      - name: Download Rust coverage
        uses: actions/download-artifact@v7
        with:
          name: rust-coverage
          path: artifacts/rust-coverage
        continue-on-error: true

      - name: Organize artifacts
        id: artifacts
        run: |
          # Playwright report is nested
          if [ -d artifacts/playwright/playwright-report ]; then
            mv artifacts/playwright/playwright-report site/playwright
          fi

          # Rust docs
          if [ -d artifacts/docs/target/doc ]; then
            mv artifacts/docs/target/doc site/rust-docs
          fi

          # TypeScript docs
          if [ -d artifacts/docs/web/docs ]; then
            mv artifacts/docs/web/docs site/ts-docs
          fi

          # Extract coverage percentages from all test types
          # Vitest
          if [ -f site/coverage/vitest/coverage-summary.json ]; then
            VITEST_LINES=$(jq -r '.total.lines.pct // 0' site/coverage/vitest/coverage-summary.json)
            VITEST_BRANCHES=$(jq -r '.total.branches.pct // 0' site/coverage/vitest/coverage-summary.json)
            VITEST_FUNCTIONS=$(jq -r '.total.functions.pct // 0' site/coverage/vitest/coverage-summary.json)
          else
            VITEST_LINES=0; VITEST_BRANCHES=0; VITEST_FUNCTIONS=0
          fi
          echo "vitest_lines=${VITEST_LINES}" >> "$GITHUB_OUTPUT"
          echo "vitest_branches=${VITEST_BRANCHES}" >> "$GITHUB_OUTPUT"
          echo "vitest_functions=${VITEST_FUNCTIONS}" >> "$GITHUB_OUTPUT"

          # Playwright
          if [ -f site/coverage/playwright/coverage-summary.json ]; then
            PW_LINES=$(jq -r '.total.lines.pct // 0' site/coverage/playwright/coverage-summary.json)
            PW_BRANCHES=$(jq -r '.total.branches.pct // 0' site/coverage/playwright/coverage-summary.json)
            PW_FUNCTIONS=$(jq -r '.total.functions.pct // 0' site/coverage/playwright/coverage-summary.json)
          else
            PW_LINES=0; PW_BRANCHES=0; PW_FUNCTIONS=0
          fi
          echo "pw_lines=${PW_LINES}" >> "$GITHUB_OUTPUT"
          echo "pw_branches=${PW_BRANCHES}" >> "$GITHUB_OUTPUT"
          echo "pw_functions=${PW_FUNCTIONS}" >> "$GITHUB_OUTPUT"

          # Rust (parse lcov file directly - must happen before artifacts cleanup)
          RUST_LCOV="artifacts/rust-coverage/backend-unit.lcov"
          if [ -f "$RUST_LCOV" ]; then
            # Sum up LF (lines found) and LH (lines hit) from lcov
            LINES_FOUND=$(grep "^LF:" "$RUST_LCOV" | cut -d: -f2 | awk '{s+=$1} END {print s+0}')
            LINES_HIT=$(grep "^LH:" "$RUST_LCOV" | cut -d: -f2 | awk '{s+=$1} END {print s+0}')
            FUNCS_FOUND=$(grep "^FNF:" "$RUST_LCOV" | cut -d: -f2 | awk '{s+=$1} END {print s+0}')
            FUNCS_HIT=$(grep "^FNH:" "$RUST_LCOV" | cut -d: -f2 | awk '{s+=$1} END {print s+0}')

            if [ "$LINES_FOUND" -gt 0 ]; then
              RUST_LINES=$(echo "scale=1; $LINES_HIT * 100 / $LINES_FOUND" | bc)
            else
              RUST_LINES=0
            fi
            if [ "$FUNCS_FOUND" -gt 0 ]; then
              RUST_FUNCTIONS=$(echo "scale=1; $FUNCS_HIT * 100 / $FUNCS_FOUND" | bc)
            else
              RUST_FUNCTIONS=0
            fi
          else
            RUST_LINES=0; RUST_FUNCTIONS=0
          fi
          echo "rust_lines=${RUST_LINES}" >> "$GITHUB_OUTPUT"
          echo "rust_functions=${RUST_FUNCTIONS}" >> "$GITHUB_OUTPUT"

          # Cleanup artifacts
          rm -rf artifacts

          # Overall coverage (vitest lines as primary)
          echo "coverage_pct=${VITEST_LINES}" >> "$GITHUB_OUTPUT"

      - name: Generate landing page
        run: |
          COMMIT_SHORT="${GITHUB_SHA:0:7}"
          BUILD_DATE="$(date -u +"%Y-%m-%d %H:%M UTC")"
          COVERAGE_PCT="${{ steps.artifacts.outputs.coverage_pct }}"

          # Coverage by test type
          VITEST_LINES="${{ steps.artifacts.outputs.vitest_lines }}"
          VITEST_BRANCHES="${{ steps.artifacts.outputs.vitest_branches }}"
          VITEST_FUNCTIONS="${{ steps.artifacts.outputs.vitest_functions }}"
          PW_LINES="${{ steps.artifacts.outputs.pw_lines }}"
          PW_BRANCHES="${{ steps.artifacts.outputs.pw_branches }}"
          PW_FUNCTIONS="${{ steps.artifacts.outputs.pw_functions }}"
          RUST_LINES="${{ steps.artifacts.outputs.rust_lines }}"
          RUST_FUNCTIONS="${{ steps.artifacts.outputs.rust_functions }}"

          cat > site/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Tiny Congress - Developer Resources</title>
            <link rel="icon" href="favicon.ico">
            <meta name="color-scheme" content="light dark">
            <style>
              :root {
                --bg: #f8fafc;
                --bg-card: #ffffff;
                --bg-hover: #f1f5f9;
                --text: #0f172a;
                --text-secondary: #64748b;
                --text-muted: #94a3b8;
                --link: #2563eb;
                --border: #e2e8f0;
                --accent: #3b82f6;
                --success: #22c55e;
                --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
              }
              @media (prefers-color-scheme: dark) {
                :root {
                  --bg: #0f172a;
                  --bg-card: #1e293b;
                  --bg-hover: #334155;
                  --text: #f1f5f9;
                  --text-secondary: #94a3b8;
                  --text-muted: #64748b;
                  --link: #60a5fa;
                  --border: #334155;
                  --accent: #3b82f6;
                  --success: #22c55e;
                  --shadow: 0 1px 3px rgba(0,0,0,0.3);
                }
              }
              * { box-sizing: border-box; }
              body {
                font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 24px;
                line-height: 1.6;
                background: var(--bg);
                color: var(--text);
              }

              /* Header with build context */
              .header {
                background: var(--bg-card);
                border-radius: 12px;
                padding: 24px;
                margin-bottom: 24px;
                box-shadow: var(--shadow);
                border: 1px solid var(--border);
              }
              .header-top {
                display: flex;
                align-items: center;
                gap: 16px;
                margin-bottom: 16px;
              }
              .logo { height: 48px; width: auto; }
              .header h1 {
                margin: 0;
                font-size: 1.75rem;
                font-weight: 600;
              }
              .build-context {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 12px;
                padding-top: 16px;
                border-top: 1px solid var(--border);
              }
              .build-item {
                display: flex;
                flex-direction: column;
                gap: 2px;
              }
              .build-label {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--text-muted);
                font-weight: 500;
              }
              .build-value {
                font-family: ui-monospace, 'SF Mono', monospace;
                font-size: 0.875rem;
                color: var(--text-secondary);
              }
              .build-value a {
                color: var(--link);
                text-decoration: none;
              }
              .build-value a:hover { text-decoration: underline; }

              /* Coverage highlight */
              .coverage-badge {
                background: linear-gradient(135deg, var(--accent), #8b5cf6);
                color: white;
                padding: 4px 12px;
                border-radius: 20px;
                font-weight: 600;
                font-size: 0.875rem;
                display: inline-flex;
                align-items: center;
                gap: 6px;
              }

              /* Sections */
              .section {
                background: var(--bg-card);
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 16px;
                box-shadow: var(--shadow);
                border: 1px solid var(--border);
              }
              .section h2 {
                margin: 0 0 16px 0;
                font-size: 1rem;
                font-weight: 600;
                color: var(--text-secondary);
                display: flex;
                align-items: center;
                gap: 8px;
              }

              /* Link grid */
              .link-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 10px;
              }
              .link-card {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 16px;
                background: var(--bg);
                border: 1px solid var(--border);
                border-radius: 8px;
                color: var(--text);
                text-decoration: none;
                transition: all 0.15s ease;
              }
              .link-card:hover {
                background: var(--bg-hover);
                border-color: var(--accent);
                transform: translateY(-1px);
              }
              .link-icon { font-size: 1.25rem; }
              .link-label { font-weight: 500; }

              /* Coverage table */
              .coverage-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 16px;
                font-size: 0.875rem;
                background: var(--bg-card);
                border-radius: 8px;
                overflow: hidden;
              }
              .coverage-table th {
                text-align: left;
                padding: 10px 14px;
                background: var(--bg-hover);
                color: var(--text-muted);
                font-weight: 500;
                text-transform: uppercase;
                font-size: 0.75rem;
                letter-spacing: 0.05em;
              }
              .coverage-table td {
                padding: 12px 14px;
                border-bottom: 1px solid var(--border);
              }
              .coverage-table tr:last-child td {
                border-bottom: none;
              }
              .coverage-table .test-type {
                display: flex;
                align-items: center;
                gap: 8px;
              }
              .coverage-table .pct {
                font-weight: 600;
                font-family: ui-monospace, monospace;
              }
              .coverage-table .pct.good { color: #22c55e; }
              .coverage-table .pct.ok { color: #eab308; }
              .coverage-table .pct.low { color: #ef4444; }
              .coverage-table a {
                color: var(--link);
                text-decoration: none;
                font-size: 0.85rem;
              }
              .coverage-table a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <header class="header">
              <div class="header-top">
                <img src="logo.png" alt="Tiny Congress" class="logo">
                <h1>Tiny Congress</h1>
                <span class="coverage-badge">
                  üìä ${COVERAGE_PCT}% coverage
                </span>
              </div>
              <div class="build-context">
                <div class="build-item">
                  <span class="build-label">Commit</span>
                  <span class="build-value"><a href="https://github.com/icook/tiny-congress/commit/${GITHUB_SHA}">${COMMIT_SHORT}</a></span>
                </div>
                <div class="build-item">
                  <span class="build-label">Branch</span>
                  <span class="build-value">${GITHUB_REF_NAME}</span>
                </div>
                <div class="build-item">
                  <span class="build-label">Built</span>
                  <span class="build-value">${BUILD_DATE}</span>
                </div>
                <div class="build-item">
                  <span class="build-label">Workflow</span>
                  <span class="build-value"><a href="https://github.com/icook/tiny-congress/actions/runs/${GITHUB_RUN_ID}">#${GITHUB_RUN_NUMBER}</a></span>
                </div>
              </div>
            </header>

            <section class="section">
              <h2>üìö API Documentation</h2>
              <div class="link-grid">
                <a href="rust-docs/tinycongress_api/" class="link-card">
                  <span class="link-icon">ü¶Ä</span>
                  <span class="link-label">Rust API Docs</span>
                </a>
                <a href="ts-docs/" class="link-card">
                  <span class="link-icon">üìò</span>
                  <span class="link-label">TypeScript Docs</span>
                </a>
              </div>
            </section>

            <section class="section">
              <h2>üìä Coverage Reports</h2>
              <table class="coverage-table">
                <thead>
                  <tr>
                    <th>Test Type</th>
                    <th>Lines</th>
                    <th>Branches</th>
                    <th>Functions</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><span class="test-type">üß™ Vitest Unit Tests</span></td>
                    <td class="pct">${VITEST_LINES}%</td>
                    <td class="pct">${VITEST_BRANCHES}%</td>
                    <td class="pct">${VITEST_FUNCTIONS}%</td>
                    <td><a href="coverage/vitest/">View Report</a></td>
                  </tr>
                  <tr>
                    <td><span class="test-type">üé≠ Playwright E2E</span></td>
                    <td class="pct">${PW_LINES}%</td>
                    <td class="pct">${PW_BRANCHES}%</td>
                    <td class="pct">${PW_FUNCTIONS}%</td>
                    <td><a href="coverage/playwright/">View Report</a></td>
                  </tr>
                  <tr>
                    <td><span class="test-type">ü¶Ä Rust Backend</span></td>
                    <td class="pct">${RUST_LINES}%</td>
                    <td class="pct">N/A</td>
                    <td class="pct">${RUST_FUNCTIONS}%</td>
                    <td><a href="coverage/rust/">View Report</a></td>
                  </tr>
                </tbody>
              </table>
              <div style="margin-top: 12px; text-align: right;">
                <a href="coverage/" style="color: var(--link); font-size: 0.875rem;">View Full Coverage Report ‚Üí</a>
              </div>
            </section>

            <section class="section">
              <h2>üß™ Test Reports</h2>
              <div class="link-grid">
                <a href="storybook/" class="link-card">
                  <span class="link-icon">üìö</span>
                  <span class="link-label">Storybook</span>
                </a>
                <a href="playwright/" class="link-card">
                  <span class="link-icon">üé≠</span>
                  <span class="link-label">Playwright E2E</span>
                </a>
              </div>
            </section>
          </body>
          </html>
          EOF

      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: tiny-congress
          directory: site
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Add PR comment with report links
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pages-reports
          message: |
            ## üèõÔ∏è CI Reports

            **[üìã All Reports](${{ steps.deploy.outputs.url }}/)**

            ### üìö API Documentation
            | | |
            |---|---|
            | ü¶Ä [Rust API Docs](${{ steps.deploy.outputs.url }}/rust-docs/tinycongress_api/) | üìò [TypeScript Docs](${{ steps.deploy.outputs.url }}/ts-docs/) |

            ### üß™ Test Artifacts
            | | |
            |---|---|
            | üìä [Coverage](${{ steps.deploy.outputs.url }}/coverage/) | üìö [Storybook](${{ steps.deploy.outputs.url }}/storybook/) |
            | üé≠ [Playwright](${{ steps.deploy.outputs.url }}/playwright/) | |

            <sub>ü§ñ Generated from commit ${{ github.sha }}</sub>
