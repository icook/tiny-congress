# syntax=docker/dockerfile:1.4
# Dev Dockerfile with BuildKit cache mounts for fast rebuilds
FROM lukemathwalker/cargo-chef:latest-rust-1.91 AS chef
WORKDIR /usr/src/app

FROM chef AS planner
COPY . .
RUN cargo chef prepare --recipe-path recipe.json

FROM chef AS builder

RUN rustup component add llvm-tools-preview

# Install dev tools with cache mounts
RUN --mount=type=cache,target=/usr/local/cargo/registry,id=cargo-registry \
    --mount=type=cache,target=/usr/local/cargo/git,id=cargo-git \
    cargo install sqlx-cli --locked --features postgres && \
    cargo install cargo-watch --locked && \
    cargo install cargo-llvm-cov --locked

WORKDIR /usr/src/app

# Cook dependencies with cache mounts
COPY --from=planner /usr/src/app/recipe.json recipe.json
RUN --mount=type=cache,target=/usr/local/cargo/registry,id=cargo-registry \
    --mount=type=cache,target=/usr/local/cargo/git,id=cargo-git \
    --mount=type=cache,target=/usr/src/app/target,id=cargo-target-dev \
    cargo chef cook --recipe-path recipe.json

# Copy source and build with cache mounts
COPY . .

ENV SQLX_OFFLINE=true

# Check sqlx prepared queries with cache mounts
RUN --mount=type=cache,target=/usr/local/cargo/registry,id=cargo-registry \
    --mount=type=cache,target=/usr/local/cargo/git,id=cargo-git \
    --mount=type=cache,target=/usr/src/app/target,id=cargo-target-dev \
    cargo sqlx prepare --check

# Build with cache mounts for fast incremental compilation
RUN --mount=type=cache,target=/usr/local/cargo/registry,id=cargo-registry \
    --mount=type=cache,target=/usr/local/cargo/git,id=cargo-git \
    --mount=type=cache,target=/usr/src/app/target,id=cargo-target-dev \
    cargo build --bin tinycongress-api && \
    cp target/debug/tinycongress-api /usr/local/bin/tinycongress-api

RUN install -m 0755 bin/dev-entrypoint.sh /usr/local/bin/dev-entrypoint

ENV PATH="/usr/local/cargo/bin:${PATH}"

# Default command: run the hot-reload dev entrypoint
CMD ["/usr/local/bin/dev-entrypoint"]
