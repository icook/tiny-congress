---
source: service/tests/schema_snapshot.rs
assertion_line: 188
expression: current_schema
---
-- Schema Snapshot
-- Generated by schema_snapshot test
-- Update: cargo insta review

CREATE TABLE account_backups (
    id UUID NOT NULL DEFAULT gen_random_uuid(),
    account_id UUID NOT NULL,
    kid TEXT NOT NULL,
    encrypted_backup BYTEA NOT NULL,
    salt BYTEA NOT NULL,
    version INT4 NOT NULL DEFAULT 1,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now());

CREATE TABLE accounts (
    id UUID NOT NULL DEFAULT gen_random_uuid(),
    username TEXT NOT NULL,
    root_pubkey TEXT NOT NULL,
    root_kid TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now());

CREATE TABLE device_keys (
    id UUID NOT NULL DEFAULT gen_random_uuid(),
    account_id UUID NOT NULL,
    device_kid TEXT NOT NULL,
    device_pubkey TEXT NOT NULL,
    device_name TEXT NOT NULL,
    certificate BYTEA NOT NULL,
    last_used_at TIMESTAMPTZ,
    revoked_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now());

CREATE TABLE request_nonces (
    nonce_hash BYTEA NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes
-- account_backups.account_backups_pkey
CREATE UNIQUE INDEX account_backups_pkey ON public.account_backups USING btree (id)

-- account_backups.uq_account_backups_account
CREATE UNIQUE INDEX uq_account_backups_account ON public.account_backups USING btree (account_id)

-- account_backups.uq_account_backups_kid
CREATE UNIQUE INDEX uq_account_backups_kid ON public.account_backups USING btree (kid)

-- accounts.accounts_pkey
CREATE UNIQUE INDEX accounts_pkey ON public.accounts USING btree (id)

-- accounts.accounts_root_kid_key
CREATE UNIQUE INDEX accounts_root_kid_key ON public.accounts USING btree (root_kid)

-- accounts.accounts_username_key
CREATE UNIQUE INDEX accounts_username_key ON public.accounts USING btree (username)

-- device_keys.device_keys_pkey
CREATE UNIQUE INDEX device_keys_pkey ON public.device_keys USING btree (id)

-- device_keys.idx_device_keys_account
CREATE INDEX idx_device_keys_account ON public.device_keys USING btree (account_id)

-- device_keys.uq_device_keys_kid
CREATE UNIQUE INDEX uq_device_keys_kid ON public.device_keys USING btree (device_kid)

-- request_nonces.idx_request_nonces_created_at
CREATE INDEX idx_request_nonces_created_at ON public.request_nonces USING btree (created_at)

-- request_nonces.request_nonces_pkey
CREATE UNIQUE INDEX request_nonces_pkey ON public.request_nonces USING btree (nonce_hash)

-- Foreign Keys
-- account_backups.account_id -> accounts.id (ON UPDATE NO ACTION, ON DELETE CASCADE)
-- device_keys.account_id -> accounts.id (ON UPDATE NO ACTION, ON DELETE CASCADE)

-- Constraints
-- account_backups: account_backups_account_id_not_null (CHECK)
-- account_backups: account_backups_created_at_not_null (CHECK)
-- account_backups: account_backups_encrypted_backup_not_null (CHECK)
-- account_backups: account_backups_id_not_null (CHECK)
-- account_backups: account_backups_kid_not_null (CHECK)
-- account_backups: account_backups_pkey (PRIMARY KEY)
-- account_backups: account_backups_salt_not_null (CHECK)
-- account_backups: account_backups_version_not_null (CHECK)
-- account_backups: uq_account_backups_account (UNIQUE)
-- account_backups: uq_account_backups_kid (UNIQUE)
-- accounts: accounts_created_at_not_null (CHECK)
-- accounts: accounts_id_not_null (CHECK)
-- accounts: accounts_pkey (PRIMARY KEY)
-- accounts: accounts_root_kid_key (UNIQUE)
-- accounts: accounts_root_kid_not_null (CHECK)
-- accounts: accounts_root_pubkey_not_null (CHECK)
-- accounts: accounts_username_key (UNIQUE)
-- accounts: accounts_username_not_null (CHECK)
-- device_keys: device_keys_account_id_not_null (CHECK)
-- device_keys: device_keys_certificate_not_null (CHECK)
-- device_keys: device_keys_created_at_not_null (CHECK)
-- device_keys: device_keys_device_kid_not_null (CHECK)
-- device_keys: device_keys_device_name_not_null (CHECK)
-- device_keys: device_keys_device_pubkey_not_null (CHECK)
-- device_keys: device_keys_id_not_null (CHECK)
-- device_keys: device_keys_pkey (PRIMARY KEY)
-- device_keys: uq_device_keys_kid (UNIQUE)
-- request_nonces: request_nonces_created_at_not_null (CHECK)
-- request_nonces: request_nonces_nonce_hash_not_null (CHECK)
-- request_nonces: request_nonces_pkey (PRIMARY KEY)
