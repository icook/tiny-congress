# yaml-language-server: $schema=https://raw.githubusercontent.com/GoogleContainerTools/skaffold/main/docs-v2/content/en/schemas/v4beta13.json
apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: prioritization-room
build:
  local:
    useBuildkit: true
    concurrency: 3
  artifacts:
    - image: tc-api-dev
      context: ./service/
      docker:
        dockerfile: Dockerfile.dev
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
        cacheFrom:
          - "tc-api-dev:cache-main"
          - "tc-api-dev:cache"
      sync:
        manual:
          - src: "src/**/*.rs"
            dest: /usr/src/app
          - src: "src/**/*.toml"
            dest: /usr/src/app
          - src: "migrations/**"
            dest: /usr/src/app
          - src: "Cargo.toml"
            dest: /usr/src/app
          - src: "Cargo.lock"
            dest: /usr/src/app
    - image: postgres
      context: .
      docker:
        dockerfile: dockerfiles/Dockerfile.postgres
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
        cacheFrom:
          - "postgres:cache-main"
          - "postgres:cache"
    - image: tc-ui-dev
      context: ./web/
      docker:
        dockerfile: Dockerfile.dev
        buildArgs:
          BUILDKIT_INLINE_CACHE: "1"
        cacheFrom:
          - "tc-ui-dev:cache-main"
          - "tc-ui-dev:cache"
deploy:
  helm:
    releases:
      - name: tc
        chartPath: kube/app
        valuesFiles:
          - kube/app/values.yaml
        version: 0.1.0
        setValueTemplates:
          image.repository: "{{.IMAGE_REPO_tc_api_dev}}"
          image.tag: "{{.IMAGE_TAG_tc_api_dev}}"
          frontend.image.repository: "{{.IMAGE_REPO_tc_ui_dev}}"
          frontend.image.tag: "{{.IMAGE_TAG_tc_ui_dev}}"
          postgres.image.repository: "{{.IMAGE_REPO_postgres}}"
          postgres.image.tag: "{{.IMAGE_TAG_postgres}}"
        setValues:
          serviceAccount:
            create: false

# Pre-deploy tests: run fast unit/API/UI tests only
test:
  - image: tc-api-dev
    custom:
      - command: >-
          docker run --rm \
            -v $(pwd)/service/coverage:/workspace/coverage \
            -v $(pwd)/service/reports:/workspace/reports \
            -e COVERAGE_DIR=/workspace/coverage \
            -e REPORTS_DIR=/workspace/reports \
            "$IMAGE" /bin/sh -lc '
              cd /usr/src/app \\
              && run-coverage-tests
            '
  - image: tc-ui-dev
    custom:
      - command: >-
          docker run --rm -e CI=true "$IMAGE" /bin/sh -lc "cd /app && yarn test --watchAll=false && yarn playwright:test"

# Post-deploy verification: run integration tests against the live cluster
verify:
  - name: integration-tests
    container:
      name: integration-tests
      image: tc-api-dev
      command: ["/bin/sh"]
      args: ["-lc", "cd /usr/src/app && DATABASE_URL=postgres://postgres:postgres@postgres:5432/prioritization /usr/local/cargo/bin/cargo test --test integration_tests -- --test-threads=1 --nocapture"]
    executionMode:
      kubernetesCluster: {}

# Ensure Postgres is reachable from localhost for developer workflows
portForward:
  - resourceType: service
    resourceName: postgres
    port: 5432
    localPort: 5432
  - resourceType: service
    resourceName: tc
    port: 80
    localPort: 8080
  - resourceType: deployment
    resourceName: tc-frontend
    port: 5173
    localPort: 5173

profiles:
  - name: dev
    build:
      local:
        push: false
    deploy:
      kubectl: {}
  - name: release
    build:
      artifacts:
        - image: tc-api-release
          context: ./service/
          docker:
            dockerfile: Dockerfile
        - image: tc-ui-release
          context: ./web/
          docker:
            dockerfile: Dockerfile
  - name: ci
    build:
      local:
        push: true
        useBuildkit: true
